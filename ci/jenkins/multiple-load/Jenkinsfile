pipeline {
    agent {label 'master'}
    
    stages {
        stage('Simulation') {
            parallel {
                stage('sim1') {
                agent{label 'agent1'}
                    steps {
                        build job: 'load-example',
                         parameters: [
                            string(name:'agentName', value:'agent1')
                         ]
                    }
                }
                stage('sim2') {
                    steps {
                        build job: 'load-example-two',
                        parameters: [
                            string(name:'agentName', value:'agent2')
                        ]
                    }
                }
            }
        }
        
        stage('Downloading Reports') {
            steps {
                agent {label 'agent1'}
                git branch: 'master',
                    credentialsId: 'GitHubAcc',
                    url: 'https://github.com/dprymudrau/gatling-example.git'
                sh "sbt -DjobNames=$JOB_NAMES 'runMain com.solvd.example.util.JenkinsUtil"
            }
        }
        
        stage('Generating Report') {
            steps {
                agent {label 'agent1'}
                sh "sbt Gatling / generateReport"
            }
        }

        post {
          // Archive the log file.
          success {
            archiveArtifacts 'target/gatling/**'
          }
        }
    }
}